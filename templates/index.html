<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ordens de Servi√ßo</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <!-- O.S em Deslocamento -->
        <h2>üöó O.S em Deslocamento</h2>
        <table id="tabela-deslocamento">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Protocolo</th>
                    <th>Status</th>
                    <th>Data Abertura</th>
                    <th>T√©cnico</th>
                    <th>Endere√ßo</th>
                    <th>Assunto</th> <!-- Exibir o assunto -->
                </tr>
            </thead>
            <tbody>
                <!-- As linhas ser√£o preenchidas dinamicamente -->
            </tbody>
        </table>

        <!-- O.S em Execu√ß√£o -->
        <h2>‚öôÔ∏è O.S em Execu√ß√£o</h2>
        <table id="tabela-execucao">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Protocolo</th>
                    <th>Status</th>
                    <th>Data Abertura</th>
                    <th>T√©cnico</th>
                    <th>Endere√ßo</th>
                    <th>Assunto</th> <!-- Exibir o assunto -->
                </tr>
            </thead>
            <tbody>
                <!-- As linhas ser√£o preenchidas dinamicamente -->
            </tbody>
        </table>

        <!-- T√©cnicos Dispon√≠veis -->
        <h2>‚úÖ T√©cnicos Dispon√≠veis</h2>
        <table id="tabela-disponiveis">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>T√©cnico</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                <!-- As linhas ser√£o preenchidas dinamicamente -->
            </tbody>
        </table>
    </div>

    <!-- Script para atualizar as tabelas dinamicamente -->
    <script>
        // Dicion√°rio de mapeamento de id_assunto para textos
        const assuntosMap = {
            5: "Sem Conex√£o",
            76: "Notifica√ß√£o",
            1: "Instala√ß√£o",
            17: "Acompanhamento T√©cnico",
            2: "Mudan√ßa de Endere√ßo",
            120: "Mudan√ßa de Local",
            160: "D3 com Defeito",
            57: "Upgrade - Troca de Equipamento",
            40: "Cancelamento",
            112: "Instala√ß√£o TV BOX",
            148: "Instala√ß√£o WIFI MAX",
        };

       // Fun√ß√£o para buscar os dados da API e atualizar as tabelas
function atualizarTabelas() {
    fetch('/api/os')  // Faz uma requisi√ß√£o GET para a rota /api/os
        .then(response => response.json())  // Converte a resposta para JSON
        .then(data => {
            console.log(data);  // Verifique os dados retornados pela API

            // Atualiza a tabela de O.S em Deslocamento
            const tabelaDeslocamento = document.querySelector('#tabela-deslocamento tbody');
            tabelaDeslocamento.innerHTML = '';  // Limpa o conte√∫do atual
            data.os_deslocamento.forEach(os => {
                const assunto = assuntosMap[os.id_assunto] || os.id_assunto || 'N/A';  // Substitui o ID pelo texto correspondente
                tabelaDeslocamento.innerHTML += `
                    <tr class="deslocamento">
                        <td>${os.id}</td>
                        <td>${os.protocolo}</td>
                        <td>${os.icone} ${os.status}</td>
                        <td>${os.data_abertura}</td>
                        <td class="nome-tecnico">${os.nome_tecnico}</td>
                        <td>${os.endereco}</td>
                        <td>${assunto}</td> <!-- Exibir o assunto -->
                    </tr>
                `;
            });

            // Atualiza a tabela de O.S em Execu√ß√£o
            const tabelaExecucao = document.querySelector('#tabela-execucao tbody');
            tabelaExecucao.innerHTML = '';  // Limpa o conte√∫do atual
            data.os_execucao.forEach(os => {
                const assunto = assuntosMap[os.id_assunto] || os.id_assunto || 'N/A';  // Substitui o ID pelo texto correspondente
                tabelaExecucao.innerHTML += `
                    <tr class="execucao">
                        <td>${os.id}</td>
                        <td>${os.protocolo}</td>
                        <td>${os.icone} ${os.status}</td>
                        <td>${os.data_abertura}</td>
                        <td class="nome-tecnico">${os.nome_tecnico}</td>
                        <td>${os.endereco}</td>
                        <td>${assunto}</td> <!-- Exibir o assunto -->
                    </tr>
                `;
            });

            // Ordena os t√©cnicos dispon√≠veis por nome
            data.tecnicos_disponiveis.sort((a, b) => a.nome_tecnico.localeCompare(b.nome_tecnico));

            // Atualiza a tabela de T√©cnicos Dispon√≠veis
            const tabelaDisponiveis = document.querySelector('#tabela-disponiveis tbody');
            tabelaDisponiveis.innerHTML = '';  // Limpa o conte√∫do atual
            data.tecnicos_disponiveis.forEach(tecnico => {
                const classe = tecnico.status === 'T√©cnico Ocupado' ? 'ocupado' : 'disponivel';
                tabelaDisponiveis.innerHTML += `
                    <tr class="${classe}">
                        <td>${tecnico.id}</td>
                        <td class="nome-tecnico">${tecnico.nome_tecnico}</td>
                        <td>${tecnico.icone} ${tecnico.status}</td>
                    </tr>
                `;
            });
        })
        .catch(error => console.error('Erro ao buscar os dados:', error));
}

        // Atualiza as tabelas a cada 5 segundos
        setInterval(atualizarTabelas, 5000);

        // Atualiza as tabelas imediatamente ao carregar a p√°gina
        atualizarTabelas();
    </script>
</body>
</html>